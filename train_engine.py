import sqlite3
import faiss
import numpy as np
from sentence_transformers import SentenceTransformer

def train_professional():
    print("Starting Professional 1 AM Update...")
    model = SentenceTransformer('all-MiniLM-L6-v2')
    
    # 1. Connect to SQL (Fetch IDs and Text only)
    conn = sqlite3.connect('tourism.db')
    cursor = conn.cursor()
    # Only fetch what we need for the vector (Title + Description)
    cursor.execute("SELECT id, title, description FROM tourism_place                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ")
    rows = cursor.fetchall()
    
    ids = np.array([r[0] for r in rows]).astype('int64')
    texts = [f"{r[1]}: {r[2]}" for r in rows]

    # 2. Generate Embeddings (Use GPU if available)
    print(f"Encoding {len(texts)} rows...")
    embeddings = model.encode(texts, batch_size=64, show_progress_bar=True)
    embeddings = np.array(embeddings).astype('float32')

    # 3. Create a Clustered Index (IVF)
    d = embeddings.shape[1]  # 384 dimensions
    nlist = int(4 * np.sqrt(len(ids))) # Clusters: ~8944 for 5M rows
    
    quantizer = faiss.IndexFlatL2(d)
    # IndexIDMap allows us to use our SQL IDs inside FAISS
    index_ivf = faiss.IndexIVFFlat(quantizer, d, nlist, faiss.METRIC_L2)
    
    print("Training clusters...")
    index_ivf.train(embeddings)
    
    print("Adding vectors with IDs...")
    index = faiss.IndexIDMap(index_ivf)
    index.add_with_ids(embeddings, ids)

    # 4. Save only the index (No more .pkl file!)
    faiss.write_index(index, "tourism.index")
    conn.close()
    print("Done! Index saved to tourism.index")

if __name__ == "__main__":
    train_professional()